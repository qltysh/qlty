name: Update CHANGELOG.md

on:
  workflow_dispatch:

jobs:
  claude:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    steps:
      - uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2
        id: app-token
        with:
          app-id: ${{ vars.QLTY_APP_ID }}
          private-key: ${{ secrets.QLTY_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 500

      - name: Install Qlty CLI
        uses: qltysh/qlty-action/install@a19242102d17e497f437d7466aa01b528537e899

      - name: Update CHANGELOG.md
        id: claude
        uses: anthropics/claude-code-base-action@e8132bc5e637a42c27763fc757faa37e1ee43b34 # beta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          prompt_file: .claude/prompts/changelog.md
          allowed_tools: "Edit,MultiEdit,LS,Read,View,Write,Glob,GlobTool,Grep,GrepTool,BatchTool,WebFetch(domain:docs.qlty.sh),Bash(git:*),Bash(qlty:*),Bash(gh pr view:*),Bash(gh release list:*)"

      - name: Commit changes
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e
        with:
          token: ${{ steps.app-token.outputs.token }}
          title: "chore: Update CHANGELOG.md"
          body: "Automated PR for updating CHANGELOG.md"
          branch: changelog
          add-paths: CHANGELOG.md
          delete-branch: true
          sign-commits: true
          commit-message: "chore: Update CHANGELOG.md"
          committer: qltysh[bot] <168846912+qltysh[bot]@users.noreply.github.com>
          author: qltysh[bot] <168846912+qltysh[bot]@users.noreply.github.com>
